<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <style type="text/css">
      html, body { height: 100%; width:100%; margin: 0; xxpadding-right: 20px; }
      #map-canvas { height: 90%; width:85%; marginxx: 20px 0 0 100px; } /* mobile: width: 100%, others: width: 85%*/
      #map-search { positionxx:absolute; width:100%; top:0; left:0; z-indexxx:+2; heightxx:1.5em; background: #A0A0A0;}
      #map-input {
        background-color: #fff;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        margin-left: 12px;
        padding: 0 11px 0 13px;
        text-overflow: ellipsis;
        xxwidth: 400px;
        width: 85%;
      }
      #list-view {
        background: #909090;
        max-width: 100px;
        min-width: 100px;
        float: left;
        padding-top: 10px;
        padding-left: 0px;
      }
      #list-view ul {
        list-style-type: none;
        padding-left: 0;
        padding-right: 0px;
      }
      #list-view li {
        height: auto;
        min-height: 30px;
        border-top: 1px solid #666;
        border-bottom: 1px solid #666;
        padding: 0 10px;
      }
      #list-view li:hover {
        cursor: pointer;
        background: #E0E000;
      }

    </style>
  </head>
  <body>
    <div id="map-search">
      <input type="button" name="searchButton" value="Search" data-bind="click: setMap">
      <input id="map-input" class="controls" type="text" placeholder="Enter a location" data-bind="textInput: mapInput, valueUpdate: 'keyup', event: {keyup: filterLocs} ">
    </div>

    <div id="list-view">
        Key Locations
        (<span data-bind="text: mapInput"></span>)
        <ul id="list-view-ul" data-bind="foreach:keyLocArray">
              <li data-bind="visible: $data.visible(), text: $data.name + $index(), click: $parent.moveToLoc"></li>
        </ul>
    </div>

    <div id="map-canvas"></div>

    <script type="text/javascript" src="js/lib/knockout-3.3.0.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZnrZl2ZiBy4Vn6_A_dcSohGg9j6nMGBE"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
    <script type="text/javascript">
    //----------------- Model ------------//
      var map;
      var markers = [];
      var infowindow = new google.maps.InfoWindow();

      var mainPlace = {          lat: 22.283, lng: 114.17, zoom: 12, name: "Hong Kong"      };
      //var place = {          lat: 51.5, lng: 0, zoom: 8, name: "London"      };
      //var place = {          lat: -34.397, lng: 150.644, name: "Sydney"      };

      /*
      var otherPlaces0 = [
                            { lat: 22.275, lng: 114.147, name: "Victoria's Peak"},
                            { lat: 22.293, lng: 114.161, name: "Victoria Harbour"},
                            { lat: 22.311, lng: 114.042, name: "Hong Kong Disneyland"},
                            { lat: 22.308, lng: 113.922, name: "Hong Kong International Airport"},
                            { lat: 22.286, lng: 114.160, name: "International Finance Center"}
                        ];
                        */

      var otherPlaces = [
                          { name: "Victoria's Peak", lat: 22.275, lng: 114.147 },
                          { name: "Hong Kong Disneyland", lat: 22.311, lng: 114.042 },
                          { name: "McDonald's", lat: 22.281, lng: 114.177 },
                          { name: "KFC", lat: 22.280, lng: 114.178 },
                          { name: "Hong Kong International Airport", lat: 22.308, lng: 113.922 },
                          { name: "International Finance Center", lat: 22.286, lng: 114.160 }
                        ];

      var vm = function() {
        var self = this;

        this.mapInput = ko.observable(); //mainPlace.name
        this.keyLocArray = ko.observableArray(otherPlaces);
        //this.markers = ko.observableArray([]);

        var marker;
        var content;
        for (var i = 0; i < otherPlaces.length; i++) {
          console.log("getMarker i is "+i+", markers.length is "+markers.length);
          //addMarker(getGMLatLng(this.keyLocArray[i]), this.keyLocArray()[i].name);
          markers[i] = null;
          marker = getMarker(getGMLatLng(this.keyLocArray()[i]), this.keyLocArray()[i].name);
          markers[i] = marker;
          this.keyLocArray()[i].j = i;
          this.keyLocArray()[i].visible = ko.observable(true);
          this.keyLocArray()[i].marker = ko.observable( marker );
          //this.keyLocArray()[i].marker( marker );
         // htmlKeyLocations += '<li>' + otherPlaces[i].name + '</li>';
          //console.log("i="+i+this.keyLocArray()[i].marker());
            google.maps.event.addListener(marker, 'click', function(e) {
              //content = "hey " + e.position;
              //infowindow.setContent(content);
              //infowindow.setPosition(e.position);
              //infowindow.open(map,marker);
            });
        }
        this.setMap = function() {
          //map.set-map(this.map-input())
          if (this.mapInput()) {
            console.log("setMap to "+this.mapInput());
          }
        };

        this.moveToLoc2 = function() {
          //move map to center on clicked key loc
          var self = this;
          console.log("in moveToLoc2 "+this.keyLocArray.length+","+JSON.stringify(this, null, 4) ); //+", "+this.keyLocArray()[1].name);
          for (var i=0; i<markers.length; i++) {
            if (this.keyLocArray()[i].visible() == false) {
              markers[i].marker.setMap(null);
            }
            markers[i].marker.setAnimation(null);
          }
        };

        this.moveToLoc = function(c) {
          //move map to center on clicked key loc

          //console.log("center map to key loc "+c.name+", "+keyLocArray()[i]);
          //this.mapInput( c.name );
          console.log("in moveToLoc1 "+self.keyLocArray()[1].visible() );
          map.setCenter(new google.maps.LatLng(c.lat, c.lng));
          for (var i=0; i<markers.length; i++) {
            markers[i].marker.setMap(null);
            console.log("i is "+i+", markers length is "+markers.length);
            if (self.keyLocArray()[i].visible() == true) {
              //console.log("marker true on "+this.keyLocArray()[i].name);
              markers[i].marker.setMap(map);
            }
            else {
              //console.log("marker false on "+this.keyLocArray()[i].name);

            }
            markers[i].marker.setAnimation(null);
          }
          //markers[c.j].setMap(map);
          markers[c.j].marker.setAnimation(google.maps.Animation.BOUNCE);
          markers[c.j].infowindow.open(markers[c.j].marker.get('map'), markers[c.j].marker);

          console.log("marker bouncy, val of infowindow property: "+ markers[c.j].infowindow);
        };

        this.filterLocs = function() {
          //var self = this;
          // Go thru OtherPlaces array, see if c.value string is in OtherPlaces array
          //console.log("in filterLocs: value is: "+self.mapInput()+"");


          // Remove initial markers on map
          if (markers.length > 0) {
            console.log("in filterLocs, markers.length is "+markers.length);
            for (var i = 0; i < markers.length; i++) {
              markers[i].marker.setMap(null);
            }
            //markers.length = 0;
          }


          for (var i=0; i<this.keyLocArray().length; i++) {
            //this.keyLocArray()[i].marker().setMap(null);
            if (this.keyLocArray()[i].name.toUpperCase().indexOf(self.mapInput().toUpperCase())>=0) {
              //console.log("yes1 "+this.keyLocArray()[i].name+","+this.keyLocArray()[i].visible()+"...");
              this.keyLocArray()[i].visible(true);
              //this.keyLocArray()[i].marker().setMap(map);
              markers[i].marker.setMap(map);
              //console.log("yes2 "+this.keyLocArray()[i].name+","+this.keyLocArray()[i].visible());
            }
            else {
              //console.log("no1 "+this.keyLocArray()[i].name+","+this.keyLocArray()[i].visible()+"...");
              this.keyLocArray()[i].visible(false);

              //console.log("no2 "+this.keyLocArray()[i].name+","+this.keyLocArray()[i].visible());
            }
          }
        };


      };

      ko.applyBindings(new vm());


    //----------------- View Model ------------//
      function initialize() {
        var mapOptions = {
          center: mainPlace,
          zoom: mainPlace.zoom
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        //var initMarkers = function() {
        //  for (var i=0; i<this.keyLocArray().length; i++) {
        //      this.keyLocArray()[i].marker().setMap(map);
        //  }
        //};
        //console.log( vm().mapInput() ); // Initialize markers on map upon loading
        //console.log( vm.getData() );

        var input = /** @type {HTMLInputElement} */(
          document.getElementById('map-input'));

          //var autocomplete = new google.maps.places.Autocomplete(input);
          //  autocomplete.bindTo('bounds', map);


        var htmlKeyLocations = "";
        // addMarker(mainPlace, mainPlace.name); // No marker for default place

        console.log("in before end of init, markers.length is "+markers.length);

        // Initial markers on map
        for (var i = 0; i < otherPlaces.length; i++) {
          //console.log("i="+i);
          addMarker(getGMLatLng(otherPlaces[i]), otherPlaces[i].name, i);
          //htmlKeyLocations += '<li>' + otherPlaces[i].name + '</li>';
          //addListenerToMarker(markers[i]);
        }


        /***
        var keyloc = document.getElementById("list-view-ul");
        keyloc.innerHTML = htmlKeyLocations;
        ***/
        console.log("in end of init, markers.length is "+markers.length);
      }
      google.maps.event.addDomListener(window, 'load', initialize);



      function getGMLatLng(placeObj) {
        return new google.maps.LatLng(placeObj.lat, placeObj.lng);
      }

      // Add a marker to the map and push to the array.
      function getMarker(location, name) {
        var marker = new google.maps.Marker({
          position: location,
          title: name
        });

        return marker;
      }

      function addMarker(location, name, i) {
        var marker = new google.maps.Marker({
          position: location,
          map: map,
          title: name
        });
        //markers.push(marker); // *** change marker to obj for infowindow

        var infowin = new google.maps.InfoWindow({
          content: "info stuff for " + i + "here."
        });

        // Get contents for infowindow on "name"
        markers[i] = { marker: marker, infowindow: infowin };

        google.maps.event.addListener(markers[i].marker, 'click', function() {
          infowin.open(markers[i].marker.get('map'), markers[i].marker);
        });
      }

      function createMarker(placeObj){
        console.log("Create marker for "+placeObj);
      };

      // Debug function to return contents of an object as JSON data
      function showObj(obj) {
        return JSON.stringify(obj, null, 4)
      }


    //----------------- View ------------//

    </script>

  </body>
</html>
